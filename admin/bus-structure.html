<!DOCTYPE html>
<html>
<head>
	<title>Bus Structure</title>

	<meta name="viewport" content="width=device-width,initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">

	<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="static/css/font-awesome.min.css">

    <script src="static/js/jquery-3.3.1.min.js"></script>
    <script src="static/js/muuri.min.js"></script>

    <style type="text/css">
		.grid {
		  position: relative;
		}
		.item {
		  display: block;
		  position: absolute;
		  width: 40px;
		  height: 40px;
		  padding: 4px;
		  margin: 1px;
		  z-index: 1;
		  background: #000;
		  color: #fff;
		}
		.item:hover{
			cursor: pointer;
		}
		.item.space{
			cursor: pointer;
			background-color: #fff;	
		}
		.item.passenger{
			background-color: blue;	
		}
		.item.reserved{
			background-color: grey;	
		}
		.item.selected{
			cursor: pointer;
			background-color: #34ed56;	
		}
		.item.muuri-item-dragging {
		  z-index: 3;
		}
		.item.muuri-item-releasing {
		  z-index: 2;
		}
		.item.muuri-item-hidden {
		  z-index: 0;
		}
		.item-content {
		  position: relative;
		  width: 100%;
		  height: 100%;
		}
	</style>
</head>
<body>
	<div class="container">
		<h2 class="text-center">Custom Bus Structure</h2>
		<hr>
		<div class="row">
			<div class="col-md-6 card py-2 bg-light" align="center">
				<h4>Layout</h4>
				<hr>
				<div class="row">
					<div class="col"><small>Selections: </small><small id="selection-count">3</small></div>
					<div class="col"><small>Pasenger: </small><small id="passenger-count">3</small></div>
					<div class="col"><small>Reserved: </small><small id="reserved-count">3</small></div>
					<div class="col"><small>Empty: </small><small id="empty-count">3</small></div>
				</div>
				<hr>
				<div id="grid" class="grid border">
				</div>
			</div>

			<div class="col-md-6 py-2">
				<div class="row">
					<div class="form-group col-6">
						<label>Columns</label>

						<select id="col-selector" class="form-control" onchange="setCols(event)">
						</select>
					</div>

					<div class="form-group col-6">
						<label>Rows</label>
						<select id="row-selector" class="form-control" onchange="setRows(event)">
						</select>
					</div>
				</div>

				<hr>

				<div class="form-group">
					<label>Actions</label>
					<div class="row px-3">
						<div id="selected-grids" class="col-md-12"></div>
						<button class="rounded-0 btn btn-primary col-6" onclick="changeGridItems(1)"><span class="fa fa-user"></span> Passenger</button>
						<button class="rounded-0 btn btn-secondary col-6" onclick="changeGridItems(2)"><span class="fa fa-user-times"></span> Reserved</button>
						<button class="rounded-0 btn btn-light col-6"  onclick="changeGridItems(0)"><span class="fa fa-minus-square-o"></span> Empty</button>
						<button class="rounded-0 btn btn-dark col-6"><span class="fa fa-undo"></span> Reset</button>
					</div>
					<!-- <div class="row">
						<div class="col"><small>Selections: </small><small id="selection-count">3</small></div>
						<div class="col"><small>Pasenger: </small><small id="passenger-count">3</small></div>
						<div class="col"><small>Reserved: </small><small id="reserved-count">3</small></div>
						<div class="col"><small>Empty: </small><small id="empty-count">3</small></div>
					</div> -->
				</div>

				<hr>

				<div class="form-group">
					<label>Seat Numbering</label>
					<div class="form-group">
						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="autoSeatNumbering" onchange="setAutoSeatNumbering(event)" checked>
							<label class="custom-control-label" for="autoSeatNumbering">Auto Seat Numbering</label>
						</div>

						<div class="custom-control custom-checkbox">
							<input type="checkbox" class="custom-control-input" id="numberReservedSeats" onchange="setNumberReservedSeats(event)" checked>
							<label class="custom-control-label" for="numberReservedSeats">Number Reserved Seats</label>
						</div>
					</div>
				</div>

				<hr>

				<div class="form-group">
					<button class="btn btn-success float-right"><span class="fa fa-check"></span> Okay</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		let grid;
		let gridItemClasses = ['space', 'passenger', 'reserved'];
		let data = {
			cols: 3,
			rows: 5,
			colList: [3,4,5,6,7],
			rowList:[5,6,7,8,9,10,11,12,13,14,15],
			autoSeatNumbering: true,
			numberReservedSeats: true,
			grids: [],
			selected: []
		}


		// data: Initialize Muuri grid
		initGrid = function(){
			grid = new Muuri('.grid', {
				dragEnabled: false,
				layoutOnResize: false
			});
		}


		// interface: put options in the column selector
		fillColSelector = function(){
			$('#col-selector').html('');

			for (var i=0; i < data.colList.length; i++) {
				colNumber = data.colList[i];
				$('#col-selector').append(`<option>${colNumber}</option>`)	
			}
		}


		// interface: put options in the row selector
		fillRowSelector = function(){
			$('#row-selector').html('');

			for (var i=0; i < data.rowList.length; i++) {
				rowNumber = data.rowList[i]
				$('#row-selector').append(`<option>${rowNumber}</option>`)	
			}
		}


		// interface: arrange grid items in the grid box
		fillGrid = function(){
			// empty selected list
			data.selected = []

			// remove all child elements from the grid box
			$('#grid').html('');

			// calculate and set the width of the grid box
			gridWidth = (data.cols*40) + (data.cols*2)
			$('#grid').width(gridWidth)

			// append grid items into grid box
			for (var i=0; i < data.grids.length; i++) {
				grid = data.grids[i];

				$('#grid').append(
					`<div class="item ${gridItemClasses[grid.grid_type]}"><div data-index="${grid.index}" id="${grid.index}" onclick="selectGrid(event)" class="item-content">${Boolean(grid.number) ? grid.number : ''}</div></div>`
				)	
			}

			// initialize Muuri grid
			initGrid();

			// update counts
			setCounts();
		}


		// data: change number of columns
		setCols = function(event){
			// change number of columns
			data.cols = parseInt(event.target.value)

			// reset grids
			setGrids();
			fillGrid();
		}


		// data: change number of columns
		setRows = function(event){
			// change number of rows
			data.rows = parseInt(event.target.value)

			// reset grids
			setGrids();
			fillGrid();
		}


		// data: set grids array
		setGrids = function(){
			// empty the grids array
			// data.grids = [];

			// get the previous number of grid items
			var p = data.grids.length;
			// calculate the new number of grid items needed
			var n = data.cols * data.rows

			// if less grid items are needed
			if (p>n) {
				// reduce the grids list
				data.grids = data.grids.slice(0, n)
			}
			// if more grid items are needed
			else if(p<n){
				var extra = n-p
				// append extra empty grids to the end of the grids list
				for (var i=p; i<p+extra; i++){
					data.grids.push({index:i, grid_type:0})
				}
			}
		}


		// data and interface: select or unselect a grid item
		selectGrid = function(event){
			// data: push to selected array if it's not there 
			if (data.selected.includes(parseInt(event.target.dataset.index))){
				data.selected = data.selected.filter((i)=>{
					return i !== parseInt(event.target.dataset.index)
				})
			}
			else {
				data.selected.push(parseInt(event.target.dataset.index))
			}

			// interface: sytle selected grid
			$(event.target).parent().toggleClass("selected");

			// interface: update counts
			setCounts();
		}


		// data and interface: change selected grid items to the specified type
		changeGridItems = function(type){
			if(data.selected.length){
				for (var i=0; i<data.selected.length; i++) {
					data.grids[data.selected[i]].grid_type = type
				}
			}
			else{
				alert("Select at least 1 grid")
			}
		
			// set seat numbers and refill the grid box
			setSeatNumbers();
		}


		// data and inteface: set seat numbers and rearrange itms in the grid
		setSeatNumbers = function(){
			// init count as 1
			n = 1

			// update the number attributes of all passenger and reserved grids
			for (var i=0; i<data.grids.length; i++){
				if ((data.grids[i].grid_type===1 && data.autoSeatNumbering) || (data.grids[i].grid_type==2 && data.numberReservedSeats)) {
					data.grids[i].number = n
					n++
				}
				else{
					data.grids[i].number = null
				}
			}

			// rearrange the grid
			fillGrid();
		}


		// data and interface: set autoSeatNumbering to true/false
		setAutoSeatNumbering = function(event){
			// sets autoSeatNumbering to true/false
			data.autoSeatNumbering = event.target.checked
			
			// update seat numbers
			setSeatNumbers()
		}


		// data and interface: sets numberReservedSeats to true/false
		setNumberReservedSeats = function(event){
			// set numberReservedSeats to true/false
			data.numberReservedSeats = event.target.checked

			// update seat numbers
			setSeatNumbers()
		}


		// interface: set selection, passenger, reserved, and empty grid counts
		setCounts = function(){
			// set selection count
			$('#selection-count').html(data.selected.length)
			
			// set passenger count
			$('#passenger-count').html(data.grids.filter((grid)=>{return grid.grid_type===1}).length)
			
			// set reserved count
			$('#reserved-count').html(data.grids.filter((grid)=>{return grid.grid_type===2}).length)
			
			// set empty count
			$('#empty-count').html(data.grids.filter((grid)=>{return grid.grid_type===0}).length)
		}

		fillColSelector();
		fillRowSelector();
		setGrids();
		fillGrid();
	</script>
</body>

</html>