{% extends 'index/manager-base.html' %}

{% block content %}
<div class="row p-2 m-0">
	<div class="col-md-3">

		<table class="table table-sm table-striped">
			<thead>
				<th colspan="2" class="p-2 border-top-0">
					Schedule
					{% if profile.is_manager %}
						{% if bus.departure_time %}
						<button data-toggle="modal" data-target="#deleteBusScheduleModal" data-patch-containers='["#deleteBusSchedulePatch"]' data-progress-container="#deleteBusSchedulePatch" data-url="{{ url_for('bus.delete_bus_schedule', bus_id=bus.id) }}" class="getRequestTrigger fa fa-times float-right btn bg-white text-danger"></button>
						{% endif %}
						<button data-toggle="modal" data-target="#updateBusScheduleModal" class="float-right fa fa-clock-o btn bg-white text-primary"></button>
					{% endif %}
				</th>
			</thead>

			<tbody>
				{% if bus.departure_time %}
				<tr>
					<td colspan="2">
						<small>Departure</small>
						<p>{{bus.departure_time|datetimeformat('%a, %d %b %Y %r')}}<p>
					</td>
				</tr>

				<tr>
					<td colspan="2">
						<small>Journey</small>
						<p>{{bus.journey}}<p>
					</td>
				</tr>

				<tr>
					<td colspan="2">
						<small>Broadcasting</small>
						<p>{% if bus.broadcast %}YES{% else %}NO{% endif %}<p>
					</td>
				</tr>				

				<tr>
					<td colspan="2">
						<small>Booking Countdown</small>
						<p id="bookingCountDown" data-stop-time="{{bus.booking_deadline|datetimeformat('%Y-%m-%d %H:%M')}}"></p>
					</td>
				</tr>

				<tr class="p-2" align="center">
					<td colspan="2"><a href="{{ url_for('bus.free_bus', bus_id=bus.id) }}" class="btn btn-warning">Free Bus</a></td>
				</tr>
				{% else %}
				
				{% if profile.is_manager %}
				<tr>
					<td colspan="2" class="text-muted" align="center">Bus not scheduled</td>
				</tr>
				{% endif %}

				{% endif %}
			</tbody>
		</table>


		{% include 'bus/update-bus-schedule-modal.html' %}
		{% include 'bus/delete-bus-schedule-modal.html' %}
	</div>
	<div class="col-md-9">
		{% include 'bus/bus-booking.html' %}
	</div>
</div>

<script>
	$().ready((event)=>{
		setTimeLeft("#bookingCountDown")
	})

	let socket;
	$(document).ready(function(){
		
		socket = io.connect('{{HOST}}');
		socket.emit('join', "{{bus}}")


		socket.on('disconnect', (data) => {
			socket = io.connect('{{HOST}}');
			socket.emit('join', "{{bus}}")
		})

		
		socket.on('create_booking_passed', function(grid){
			data.grids[grid.index] = grid
			fillGrid()
			$(".ajaxForm").on('submit', ajaxSubmit)
			$("#createBookingModal").modal('hide')
			loadUrl("{{url_for('booking.get_bus_bookings', bus_id=bus.id)}}", "#busBookingsPatch", ["#busBookingsPatch"])

		})

		socket.on('create_booking_failed', function(errors){
			alert(JSON.stringify(errors))
		})

		socket.on('update_booking_passed', function(grid){
			data.grids[grid.index] = grid
			fillGrid()
			$(".ajaxForm").on('submit', ajaxSubmit)
			$("#updateBookingModal").modal('hide')
			loadUrl("{{url_for('booking.get_bus_bookings', bus_id=bus.id)}}", "#busBookingsPatch", ["#busBookingsPatch"])
		})

		socket.on('delete_booking_passed', function(grid){
			data.grids[grid.index] = grid
			fillGrid()
			$(".ajaxForm").on('submit', ajaxSubmit)
			$("#deleteBookingModal").modal('hide')
			loadUrl("{{url_for('booking.get_bus_bookings', bus_id=bus.id)}}", "#busBookingsPatch", ["#busBookingsPatch"])
		})
	})
</script>
{% endblock %}